# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# DO NOT EDIT THIS FILE DIRECTLY!
# This file is automatically generated at runtime.
# To modify app.yaml configuration, edit adapters/cloud/app-yaml.js instead.
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

name: Deploy-GCP
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: |
          TEST_FILES=$(find adapters logic ports presenters -path "*/tests/*test*.js")
          node --test --experimental-test-coverage="directory=coverage" $TEST_FILES && node --no-warnings logic/tools/cleanup.js fullCleanup
      
      - name: Generate static HTML
        run: node ports/static/build.js
        env:
          API_BASE: ${{ secrets.API_BASE }}
      
      # Create a simplified app.yaml for deployment
      - name: Create deployment app.yaml
        run: |
          cat > deploy.yaml << 'EOL'
          runtime: nodejs20
          instance_class: F2
          automatic_scaling:
            max_instances: 20
          handlers:
            - url: /.*
              script: auto
              secure: always
          EOL
      
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.DEPLOY_TO_GCP }}
          export_environment_variables: true
          create_credentials_file: true
      
      - name: Deploy to App Engine
        uses: google-github-actions/deploy-appengine@v2
        with:
          project_id: norml-459701
          deliverables: deploy.yaml
          version: v1
          promote: true
          env_vars: MONGODB_URI=${{ secrets.MONGO_URI }},API_BASE=${{ secrets.API_BASE }} 