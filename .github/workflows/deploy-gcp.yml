name: Deploy-GCP
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: |
          TEST_FILES=$(find adapters logic ports presenters -path "*/tests/*test*.js")
          node --test --experimental-test-coverage="directory=coverage" $TEST_FILES && node --no-warnings logic/tools/cleanup.js fullCleanup
      
      - name: Generate static HTML
        run: node ports/static/build.js
        env:
          API_BASE: ${{ secrets.API_BASE }}
      
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.DEPLOY_TO_GCP }}
          token_format: 'access_token'
      
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'beta,app-engine-python'
      
      - name: Verify gcloud installation
        run: |
          gcloud --version
          gcloud auth list
      
      - name: Deploy to Google App Engine
        run: |
          echo "Deploying to Google App Engine..."
          gcloud app deploy app.yaml --quiet --project="norml-459701" --set-env-vars="MONGODB_URI=${{ secrets.MONGO_URI }},API_BASE=${{ secrets.API_BASE }}" 